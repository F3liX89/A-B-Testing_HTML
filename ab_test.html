<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Bayesian A/B Test</title>
<script src="plotly.min.js"></script>
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f4f6f9;
    margin: 40px;
    color: #2c3e50;
}
h1 { margin-bottom: 30px; }
.card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}
button {
    background: #0052cc;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
}
button:hover { background: #003f9e; }
input {
    padding: 6px;
    margin: 5px;
    width: 100px;
}
.variant-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}
.variant-row span {
    width: 100px;
    font-weight: 600;
}
#results { margin-top: 30px; }
.kpi {
    font-size: 18px;
    margin: 8px 0;
}
</style>
</head>

<body>

<h1>Bayesian A/B Testing Dashboard</h1>

<div class="card">
<h3>Varianten</h3>
<div id="variants"></div>
<button onclick="addVariant()">+ Variante hinzuf√ºgen</button>
</div>

<div class="card">
<button onclick="runTest()">Analyse starten</button>
</div>

<div id="results"></div>

<script>
let variantCount = 0;

function addVariant() {
    variantCount++;
    const div = document.createElement("div");
    div.className = "variant-row";
    div.innerHTML = `
        <span>Variante ${variantCount}</span>
        Besucher: <input type="number" id="n_${variantCount}" value="1000">
        Conversions: <input type="number" id="c_${variantCount}" value="100">
    `;
    document.getElementById("variants").appendChild(div);
}

addVariant(); // mindestens eine

function betaSample(alpha, beta) {
    const x = gammaSample(alpha);
    const y = gammaSample(beta);
    return x / (x + y);
}

function gammaSample(shape) {
    const d = shape - 1/3;
    const c = 1 / Math.sqrt(9*d);
    while(true) {
        let x = normalSample();
        let v = Math.pow(1 + c*x, 3);
        if(v > 0) {
            let u = Math.random();
            if(u < 1 - 0.0331 * Math.pow(x,4) ||
               Math.log(u) < 0.5*x*x + d*(1-v+Math.log(v))) {
                return d*v;
            }
        }
    }
}

function normalSample() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function runTest() {
    const samples = 500000;
    const variants = [];

    for(let i=1; i<=variantCount; i++) {
        const n = parseInt(document.getElementById(`n_${i}`).value);
        const c = parseInt(document.getElementById(`c_${i}`).value);
        variants.push({n, c, alpha: 1+c, beta: 1+n-c});
    }

    const posteriors = variants.map(v =>
        Array.from({length:samples}, () => betaSample(v.alpha, v.beta))
    );

    const probsBetter = [];
    const bestCounts = Array(variantCount).fill(0);

    for(let i=0; i<samples; i++) {
        const sampleValues = posteriors.map(p => p[i]);
        const maxVal = Math.max(...sampleValues);
        const bestIndex = sampleValues.indexOf(maxVal);
        bestCounts[bestIndex]++;
    }

    for(let i=0; i<variantCount; i++) {
        probsBetter.push(bestCounts[i]/samples);
    }

    showResults(posteriors, probsBetter);
}

function showResults(posteriors, probsBetter) {
    const traces = posteriors.map((p, i) => ({
        x: p.map(x => x*100),
        type: 'histogram',
        opacity: 0.5,
        name: `Variante ${i+1}`,
        histnorm: 'probability density'
    }));

    Plotly.newPlot('results', traces, {
        barmode: 'overlay',
        title: 'Posterior-Verteilungen (%)',
        xaxis: {title: 'Conversion Rate'},
        yaxis: {title: 'Dichte'}
    });

    const winnerTrace = {
        x: probsBetter.map(p => p*100),
        y: probsBetter.map((_, i) => `Variante ${i+1}`),
        type: 'bar',
        orientation: 'h'
    };

    const winnerDiv = document.createElement("div");
    document.body.appendChild(winnerDiv);

    Plotly.newPlot(winnerDiv, [winnerTrace], {
        title: 'Wahrscheinlichkeit, Sieger zu sein (%)',
        xaxis: {range:[0,100]}
    });
}
</script>

</body>
</html>